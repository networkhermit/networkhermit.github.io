<!DOCTYPE html>
<html lang="en">
<html class="dark light">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    

    
    
    
    <title>
         Brandur Blog: Soft Deletion Probably Isn&#x27;t Worth It
        
    </title>

        
            <meta property="og:title" content="Brandur Blog: Soft Deletion Probably Isn&#x27;t Worth It" />
        
     

     
         
     

     
         
    

    
    
        <link rel="icon" type="image/png" href=&#x2F;images&#x2F;favicon.ico />
    

    
    
        <link href=https://blog.vac.fun/fonts.css rel="stylesheet" />
    

    
    


    

    
    <link rel="alternate" type="application/atom+xml" title="hi, I’m vac" href="https://blog.vac.fun/atom.xml">


    
    
        <link rel="stylesheet" type="text/css" href=https://blog.vac.fun/theme/light.css />
        <link rel="stylesheet" type="text/css" href="https://blog.vac.fun/theme/dark.css" media="(prefers-color-scheme: dark)" />
    
    
    <!-- Set the correct theme in the script -->
    <script src=https://blog.vac.fun/js/themetoggle.js></script>
    
        <script>
            if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                setTheme("dark");
            } else {
                setTheme("light");
            }
        </script>
    

    <link rel="stylesheet" type="text/css" media="screen" href=https://blog.vac.fun/main.css />

    
        
            <link rel="stylesheet" href="https://blog.vac.fun/css/theme.css">
        
    
</head>


<body>
    <div class="content">
        <header>
    <div class="main">
        <a href=https:&#x2F;&#x2F;blog.vac.fun>hi, I’m vac</a>

        <div class="socials">
            
        </div>
    </div>

    <nav>
        
        <a href=https://blog.vac.fun/posts style="margin-left: 0.7em">&#x2F;posts</a>
        
        <a href=https://blog.vac.fun/prism style="margin-left: 0.7em">&#x2F;prism</a>
        
        <a href=https://blog.vac.fun/about style="margin-left: 0.7em">&#x2F;about</a>
        

        
    </nav>
</header>


        
        
    
<main>
    <article>
        <div class="title">
            
            
    <div class="page-header">
        Brandur Blog: Soft Deletion Probably Isn&#x27;t Worth It<span class="primary-color" style="font-size: 1.6em">.</span>
    </div>


                <div class="meta">
                    
                        Posted on <time>2022-07-20</time>
                    

                    
                </div>
        </div>

        

        
        

        <section class="body">
            <blockquote>
<p><strong>Code leakage</strong>: The first is that soft deletion logic bleeds out into all parts of your code.
And forgetting that extra predicate on <code>deleted_at</code> can have dangerous consequences as it
accidentally returns data that’s no longer meant to be seen.</p>
<hr />
<p><strong>Losing foreign keys</strong>: Another consequence of soft deletion is that foreign keys are effectively
lost. The major benefit of foreign keys is that they guarantee referential integrity. But with
soft deletion, this goes out the window. A customer may be soft deleted with its <code>deleted_at</code> flag
set, but we’re now back to being able to forget do the same for its invoices.</p>
<hr />
<p><strong>Pruning data is hard</strong>: You may eventually find yourself writing a hard deletion process which
looks at soft deleted records beyond a certain horizon and permanently deletes them from the
database. But the same foreign keys that soft deletion rendered mostly useless now make this job
more difficult because a record can’t be removed without also making sure that all its
dependencies are removed as well. And even with liberal testing, this kind of query can still end
up being a reliability problem because in case a new dependency is added in the future but an
update to the query is forgotten, it’ll suddenly start failing after a year’s (or whatever the
hard delete horizon is) delay.</p>
<hr />
<p><strong>Discouraged and rarely used</strong>: Once again, soft deletion is theoretically a hedge against
accidental data loss. As a last argument against it, I’d ask you to consider, realistically,
whether undeletion is something that’s ever actually done. The biggest reason for that is that
almost always, data deletion also has non-data side effects. Calls may have been made to foreign
systems to archive records there, objects may have been removed in blob stores, or servers spun
down. The process can’t simply be reversed by setting <code>NULL</code> on <code>deleted_at</code> – equivalent undos
need to exist for all those other operations too, and they rarely do.</p>
<hr />
<p><strong>Alternative - A deleted records table</strong>: Although I’ve never seen an undelete work in practice,
soft deletion wasn’t completely useless because we would occasionally use it to refer to deleted
data – usually a manual process where someone wanted to see to a deleted object for purposes of
assisting with a support ticket or trying to squash a bug. And while I’d argue against the
traditional soft deletion pattern due to the downsides listed above, luckily there’s a compromise.
Instead of keeping deleted data in the same tables from which it was deleted from, there can be a
new relation specifically for storing all deleted data, and with a flexible <code>jsonb</code> column so that
it can capture the properties of any other table.</p>
<ul>
<li>
<p>Queries for normal, non-deleted data no longer need to include <code>deleted_at IS NULL</code> everywhere.</p>
</li>
<li>
<p>Foreign keys still work. Attempting to remove a record without also getting its dependencies is
an error.</p>
</li>
<li>
<p>Hard deleting old records for regulatory requirements gets really, really easy: <code>DELETE FROM deleted_record WHERE deleted_at &lt; now() - '1 year'::interval</code>.</p>
</li>
<li>
<p>Deleted data is a little harder to get at, but not by much, and is still kept around in case
someone needs to look at it.</p>
</li>
</ul>
</blockquote>
<p><a href="https://brandur.org/soft-deletion">Link</a></p>
<p><a href="https://brandur.org/fragments/deleted-record-insert">Easy, alternative soft deletion: <code>deleted_record_insert</code></a></p>

        </section>

        

    </article>
</main>


        
        
    </div>
</body>

</html>
