<!DOCTYPE html>
<html lang="en">
<html class="dark light">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    

    
    
    
    <title>
         Cloudflare Blog: The story of one latency spike &amp; The revenge of the listening sockets
        
    </title>

        
            <meta property="og:title" content="Cloudflare Blog: The story of one latency spike &amp; The revenge of the listening sockets" />
        
     

     
         
     

     
         
    

    
    
        <link rel="icon" type="image/png" href=&#x2F;images&#x2F;favicon.ico />
    

    
    
        <link href=https://blog.vac.fun/fonts.css rel="stylesheet" />
    

    
    


    

    
    <link rel="alternate" type="application/atom+xml" title="hi, I’m vac" href="https://blog.vac.fun/atom.xml">


    
    
        <link rel="stylesheet" type="text/css" href=https://blog.vac.fun/theme/light.css />
        <link rel="stylesheet" type="text/css" href="https://blog.vac.fun/theme/dark.css" media="(prefers-color-scheme: dark)" />
    

    <link rel="stylesheet" type="text/css" media="screen" href=https://blog.vac.fun/main.css />

    
        
            <link rel="stylesheet" href="https://blog.vac.fun/css/theme.css">
        
    
</head>


<body>
    <div class="content">
        <header>
    <div class="main">
        <a href=https:&#x2F;&#x2F;blog.vac.fun>hi, I’m vac</a>

        <div class="socials">
            
        </div>
    </div>

    <nav>
        
        <a href=https://blog.vac.fun/posts style="margin-left: 0.7em">&#x2F;posts</a>
        
        <a href=https://blog.vac.fun/prism style="margin-left: 0.7em">&#x2F;prism</a>
        
        <a href=https://blog.vac.fun/about style="margin-left: 0.7em">&#x2F;about</a>
        

        
    </nav>
</header>


        
        
    
<main>
    <article>
        <div class="title">
            
            
    <div class="page-header">
        Cloudflare Blog: The story of one latency spike &amp; The revenge of the listening sockets<span class="primary-color" style="font-size: 1.6em">.</span>
    </div>


                <div class="meta">
                    
                        Posted on <time>2022-09-12</time>
                    

                    
                </div>
        </div>

        

        
        

        <section class="body">
            <blockquote>
<p>Using a large chunk of receive buffer space for the metadata is not really what the programmer
wants. To counter that, when the socket is under memory pressure complex logic is run with the
intention of freeing some space. One of the operations is <code>tcp_collapse</code> and it will merge
adjacent TCP packets into one larger <code>sk_buff</code>. This behavior is pretty much a garbage collection
(GC)—and as everyone knows, when the garbage collection kicks in, the latency must spike.</p>
</blockquote>
<p><a href="https://blog.cloudflare.com/the-story-of-one-latency-spike/">The story of one latency spike</a></p>
<blockquote>
<p>You can't have a very large number of bound TCP sockets and we learned that the hard way. We
learned a bit about the Linux networking stack: the fact that <code>LHTABLE</code> is fixed size and is
hashed by destination port only.</p>
</blockquote>
<p><a href="https://blog.cloudflare.com/revenge-listening-sockets/">The revenge of the listening sockets</a></p>

        </section>

        

    </article>
</main>


        
        
    </div>
</body>

</html>
